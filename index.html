<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤é€šé£é™©é¢„è­¦ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }
        .content { padding: 20px; }
        .panel { background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 5px; border-left: 4px solid #3498db; }
        .upload-area { border: 2px dashed #3498db; padding: 30px; text-align: center; margin-bottom: 15px; border-radius: 5px; cursor: pointer; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .btn-success { background: #27ae60; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
        .stat-card { background: white; padding: 15px; text-align: center; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 24px; font-weight: bold; }
        .progress { background: #ecf0f1; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: #3498db; height: 100%; width: 0%; transition: width 0.3s; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #34495e; color: white; }
        .error { background: #e74c3c; color: white; padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
        .success { background: #27ae60; color: white; padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš¦ äº¤é€šé£é™©é¢„è­¦ç³»ç»Ÿ</h1>
            <p>æ£€æµ‹è¶…é€Ÿã€é—¯çº¢ç¯ã€é€†è¡Œç­‰è¿è§„è¡Œä¸º</p>
        </header>
        
        <div class="content">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="panel">
                <h2>è§†é¢‘åˆ†æ</h2>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“¹</div>
                    <h3>ç‚¹å‡»ä¸Šä¼ äº¤é€šè§†é¢‘</h3>
                    <p>æ”¯æŒ MP4, AVI, MOV æ ¼å¼</p>
                    <input type="file" id="videoFile" accept="video/*" style="display: none;">
                    <button class="btn" id="uploadBtn">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                
                <div id="fileInfo" style="display: none; margin: 15px 0;">
                    <p>å·²é€‰æ‹©: <strong id="fileName"></strong></p>
                    <button class="btn btn-success" id="analyzeBtn">å¼€å§‹åˆ†æ</button>
                </div>
                
                <div class="error" id="errorMessage"></div>
                <div class="success" id="successMessage"></div>
                
                <div id="progressSection" style="display: none;">
                    <h3>åˆ†æè¿›åº¦</h3>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p id="progressText">å‡†å¤‡å¼€å§‹...</p>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="panel">
                <h2>å®æ—¶ç»Ÿè®¡</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalVehicles">0</div>
                        <div>è½¦æµé‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="violationCount">0</div>
                        <div>è¿è§„æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accidentRisk">0%</div>
                        <div>äº‹æ•…é£é™©</div>
                    </div>
                </div>
            </div>
            
            <!-- è¿è§„è¯¦æƒ… -->
            <div class="panel">
                <h2>è¿è§„è¯¦æƒ…</h2>
                <table id="violationsTable">
                    <thead>
                        <tr>
                            <th>ç±»å‹</th>
                            <th>è½¦ç‰Œ</th>
                            <th>æè¿°</th>
                            <th>æ—¶é—´</th>
                            <th>ä½ç½®</th>
                        </tr>
                    </thead>
                    <tbody id="violationsBody">
                        <tr><td colspan="5" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentFilename = '';
        
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('videoFile');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileSelect(this.files[0]);
                }
            });
            
            // åˆ†ææŒ‰é’®ç‚¹å‡»
            analyzeBtn.addEventListener('click', analyzeVideo);
        });
        
        function handleFileSelect(file) {
            // ç®€å•éªŒè¯
            if (!file.type.startsWith('video/')) {
                showError('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº100MBçš„æ–‡ä»¶');
                return;
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').style.display = 'block';
            
            // ä¸Šä¼ æ–‡ä»¶
            uploadVideo(file);
        }
        
        function uploadVideo(file) {
            const formData = new FormData();
            formData.append('video', file);
            
            showProgress('ä¸Šä¼ ä¸­...', 20);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentFilename = data.filename;
                showProgress('ä¸Šä¼ æˆåŠŸ!', 40);
                document.getElementById('analyzeBtn').disabled = false;
                showSuccess('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œå¯ä»¥å¼€å§‹åˆ†æäº†');
            })
            .catch(error => {
                showError('ä¸Šä¼ å¤±è´¥: ' + error.message);
            });
        }
        
        function analyzeVideo() {
            if (!currentFilename) {
                showError('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            showProgress('åˆ†æä¸­...', 60);
            document.getElementById('analyzeBtn').disabled = true;
            
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: currentFilename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // æ¨¡æ‹Ÿè¿›åº¦
                setTimeout(() => {
                    showProgress('ç”ŸæˆæŠ¥å‘Š...', 100);
                    setTimeout(() => {
                        displayResults(data.results);
                        showSuccess('åˆ†æå®Œæˆ!');
                    }, 1000);
                }, 2000);
            })
            .catch(error => {
                showError('åˆ†æå¤±è´¥: ' + error.message);
                document.getElementById('analyzeBtn').disabled = false;
            });
        }
        
        function displayResults(results) {
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('totalVehicles').textContent = results.real_time_stats.vehicle_count;
            document.getElementById('violationCount').textContent = results.real_time_stats.violation_count;
            document.getElementById('accidentRisk').textContent = results.accident_probability + '%';
            
            // æ›´æ–°è¿è§„è¡¨æ ¼
            const tbody = document.getElementById('violationsBody');
            tbody.innerHTML = '';
            
            if (results.violations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æœªæ£€æµ‹åˆ°è¿è§„è¡Œä¸º</td></tr>';
            } else {
                results.violations.forEach(violation => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${getViolationType(violation.type)}</td>
                        <td>${violation.license_plate}</td>
                        <td>${violation.description}</td>
                        <td>${violation.timestamp}</td>
                        <td>${violation.location}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function getViolationType(type) {
            const types = {
                'speeding': 'ğŸš— è¶…é€Ÿ',
                'run_red_light': 'ğŸš¦ é—¯çº¢ç¯',
                'reverse_driving': 'â†©ï¸ é€†è¡Œ',
                'no_pedestrian_yield': 'ğŸš¸ æœªç¤¼è®©è¡Œäºº',
                'run_yellow_light': 'ğŸŸ¡ é»„ç¯è¿è§„'
            };
            return types[type] || type;
        }
        
        function showProgress(text, percent) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressBar').style.width = percent + '%';
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>